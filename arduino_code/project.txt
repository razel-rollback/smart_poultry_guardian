#include "DHT.h"
#include <Servo.h>

#define DHTPIN 8
#define DHTTYPE DHT22
#define FAN_PIN 9
#define SERVO_PIN 10 

DHT dht(DHTPIN, DHTTYPE);
Servo myServo;

unsigned long previousMillis = 0;
const long interval = 2000; // Read sensor every 2 seconds

void setup() {
  Serial.begin(9600);
  pinMode(FAN_PIN, OUTPUT);
  myServo.attach(SERVO_PIN);
  myServo.write(0); // Initial Position
  dht.begin();
}

void loop() {
  // 1. LISTEN FOR COMMANDS FROM PYTHON (Fan or Feed)
  if (Serial.available() > 0) {
    char command = Serial.read();
    
    if (command == 'F') {       // Feed Command
      myServo.write(90);        // Open
      delay(1000);              // Wait (Blocking is okay here briefly)
      myServo.write(0);         // Close
    } 
    else if (command == 'H') {  // Fan High (ON)
      digitalWrite(FAN_PIN, HIGH);
    } 
    else if (command == 'L') {  // Fan Low (OFF)
      digitalWrite(FAN_PIN, LOW);
    }
  }

  // 2. READ SENSOR (Non-blocking)
  unsigned long currentMillis = millis();
  if (currentMillis - previousMillis >= interval) {
    previousMillis = currentMillis;
    
    float h = dht.readHumidity();
    float t = dht.readTemperature();

    if (!isnan(h) && !isnan(t)) {
      // Send data to Python: "DATA:28.50,60.00"
      Serial.print("DATA:");
      Serial.print(t);
      Serial.print(",");
      Serial.println(h);
    }
  }
}